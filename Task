<?php
// Safaricom Daraja credentials
$consumerKey = 'your_consumer_key';
$consumerSecret = 'your_consumer_secret';
$shortCode = 'your_shortcode'; // Your Paybill or Till Number
$passkey = 'your_passkey';
$timestamp = date('YmdHis');
$password = base64_encode($shortCode . $passkey . $timestamp);

// Step 1: Generate Access Token
$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, 'https://api.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials');
curl_setopt($curl, CURLOPT_HTTPHEADER, ['Authorization: Basic ' . base64_encode("$consumerKey:$consumerSecret")]);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($curl);
$accessToken = json_decode($response)->access_token;
curl_close($curl);

// Step 2: Initiate STK Push
$stkURL = 'https://api.safaricom.co.ke/mpesa/stkpush/v1/processrequest';

$data = [
    'BusinessShortCode' => $shortCode, // Your Paybill or Till number
    'Password' => $password,
    'Timestamp' => $timestamp,
    'TransactionType' => 'CustomerPayBillOnline',
    'Amount' => '1000', // Payment amount
    'PartyA' => '2547XXXXXXXX', // Customer phone number
    'PartyB' => '222222', // Target Paybill number
    'PhoneNumber' => '2547XXXXXXXX', // Customer phone number
    'CallBackURL' => 'https://yourdomain.com/callback', // Your callback URL
    'AccountReference' => 'ReferenceNumber', // NTSA Reference, e.g., car registration
    'TransactionDesc' => 'Payment for NTSA services' // Description of the transaction
];

$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, $stkURL);
curl_setopt($curl, CURLOPT_HTTPHEADER, [
    'Authorization: Bearer ' . $accessToken,
    'Content-Type: application/json'
]);
curl_setopt($curl, CURLOPT_POST, true);
curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($data));
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($curl);
curl_close($curl);

// Output response
echo $response;
?>